import pandas as pd
import json
import base64
import os
import sys
import webbrowser
from pathlib import Path

# --- إعدادات الملفات ---
# تأكد من أن هذه الملفات موجودة في نفس مجلد السكربت
try:
    SCRIPT_DIR = Path(__file__).parent.absolute()
except NameError:
    # للعمل في البيئات التفاعلية مثل Jupyter
    SCRIPT_DIR = Path.cwd()

EXCEL_FILE = SCRIPT_DIR / "تنزيل القرآن الكريم.xlsx"
FONT_FILE = SCRIPT_DIR / "UthmanicQalounV21.ttf"
OUTPUT_HTML = SCRIPT_DIR / "عرض_القرآن_الكريم_المدمج.html"

# --- 1. تحميل وتجهيز الخط ---
print("جاري تحميل ملف الخط...")
try:
    with open(FONT_FILE, "rb") as f:
        font_data = f.read()
    font_base64 = base64.b64encode(font_data).decode("utf-8")
    css_font_face = f"""
    @font-face {{
      font-family: 'UthmanicQaloun';
      src: url(data:font/truetype;charset=utf-8;base64,{font_base64}) format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }}
    """
    print(f"✅ تم تحميل الخط: {FONT_FILE.name}")
except FileNotFoundError:
    print(f"خطأ فادح: ملف الخط '{FONT_FILE.name}' غير موجود. يرجى وضعه بجانب ملف البايثون.")
    sys.exit(1)
except Exception as e:
    print(f"خطأ غير متوقع أثناء تحميل الخط: {e}")
    sys.exit(1)

# --- 2. تحميل ومعالجة بيانات الإكسل ---
print("جاري تحميل بيانات الإكسل...")
try:
    df = pd.read_excel(EXCEL_FILE)
    print(f"✅ تم تحميل البيانات: {EXCEL_FILE.name} (عدد السجلات: {len(df)})")
except FileNotFoundError:
    print(f"خطأ فادح: ملف الإكسل '{EXCEL_FILE.name}' غير موجود. يرجى وضعه بجانب ملف البايثون.")
    sys.exit(1)
except Exception as e:
    print(f"خطأ غير متوقع أثناء تحميل ملف الإكسل: {e}")
    sys.exit(1)

# التحقق من وجود الأعمدة المطلوبة
required_columns = ["التنزيلة", "مجموعة", "عنوان", "ترميز", "السورة", "البيت"]
missing_columns = [col for col in required_columns if col not in df.columns]
if missing_columns:
    print(f"تحذير: الأعمدة التالية غير موجودة في الملف: {', '.join(missing_columns)}. قد لا تعمل بعض الميزات بشكل صحيح.")

# تحويل البيانات إلى JSON مع معالجة القيم الفارغة
records = df.fillna("").to_dict(orient="records")
data_json = json.dumps(records, ensure_ascii=False)


# --- 3. بناء ملف HTML المدمج ---
html_template = f"""
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تنزيل القرآن الكريم</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    {css_font_face}
    * {{ box-sizing: border-box; margin: 0; padding: 0; }}

    body {{
      font-family: 'UthmanicQaloun', 'Cairo', 'Segoe UI', sans-serif;
      background: linear-gradient(120deg, #f8fafc 70%, #e3eefe 100%);
      color: #2d3748;
      line-height: 1.7;
      min-height: 100vh;
    }}

    /* --- شاشة البداية --- */
    #landing-page {{
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }}
    #landing-page h1 {{
      font-size: 2.5rem;
      color: #1e3a8a;
      margin-bottom: 40px;
      text-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }}
    .choice-container {{
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      justify-content: center;
    }}
    .choice-card {{
      background: #fff;
      border: 1px solid #e0e7ff;
      border-radius: 16px;
      padding: 30px 40px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      width: 300px;
    }}
    .choice-card:hover {{
      transform: translateY(-8px);
      box-shadow: 0 12px 30px rgba(30, 64, 175, 0.15);
    }}
    .choice-card h2 {{
      color: #1e40af;
      font-size: 1.8rem;
      margin-bottom: 10px;
    }}
    .choice-card p {{
      font-size: 1.1rem;
      color: #4b5563;
    }}

    /* --- الواجهة الرئيسية للتطبيق --- */
    #main-app {{ display: none; }}

    .header {{
      position: relative;
      padding: 20px 4vw;
      text-align: center;
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }}
    .header h1 {{ font-size: 2.3rem; color: #1e3a8a; }}
    #current-note {{ margin-top: 8px; font-size: 1.1rem; color: #4b5563; }}
    
    .controls-container {{
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        right: 4vw;
        display: flex;
        gap: 15px;
        align-items: center;
    }}

    #home-btn, #top-back-btn {{
      background: #1e40af;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: background 0.2s, transform 0.1s;
      font-size: 1rem;
      font-weight: 500;
      font-family: inherit;
    }}
    #home-btn:hover, #top-back-btn:hover {{
      background: #1e3a8a;
      transform: translateY(-2px);
    }}
    #top-back-btn:disabled {{
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }}

    #font-slider-wrapper {{
      background: rgba(255,255,255,0.9);
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }}
    #font-slider-wrapper label {{ font-weight: bold; color: #4b5563; margin-bottom: 4px; display: block; }}
    #font-slider {{ width: 150px; }}
    
    .search-container {{ margin: 20px 4vw; display: flex; justify-content: center; }}
    #search-input {{
      width: 100%; max-width: 500px; padding: 12px 16px; font-size: 1rem;
      border: 1px solid #d1d5db; border-radius: 8px; background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: border-color 0.2s, box-shadow 0.2s; font-family: inherit;
    }}
    #search-input:focus {{ outline: none; border-color: #1e40af; box-shadow: 0 0 0 3px rgba(30,64,175,0.2); }}

    .cards-container {{
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px; margin: 0 4vw 40px; padding-bottom: 20px;
    }}
    .card {{
      background: #fff; border: 1px solid #e0e7ff; border-radius: 12px;
      padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); cursor: pointer;
      transition: box-shadow 0.2s, transform 0.2s; text-align: center;
      min-height: 120px; font-size: 1.15rem; color: #2d3748;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }}
    .card:hover {{ box-shadow: 0 6px 16px rgba(0,0,0,0.1); transform: translateY(-3px); }}
    .card h3 {{ margin: 0 0 10px; color: #1e3a8a; }}
    .card p.count {{
      margin-top: 0.6rem; color: #1e40af; font-size: 0.95rem; font-weight: 600;
      background: #eff6ff; border-radius: 6px; padding: 4px 8px; display: inline-block;
    }}
    .card p.sura {{ margin-top: 0.6rem; color: #4b5563; font-size: 0.9rem; }}
    .highlight {{ color: #dc2626; font-weight: bold; }}

    .poem-container {{ display: none; margin: 40px auto; max-width: 600px; text-align: center; }}
    .poem-box {{
        background: #ffffff; border: 3px dashed #c7d2fe; border-radius: 12px;
        padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); line-height: 1.8;
    }}

    .share-container {{ display: none; margin: 40px 4vw; text-align: center; }}
    .share-card {{
      background: #fff; border: 1px solid #e0e7ff; border-radius: 12px; padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06); text-align: center;
    }}
    .share-card h3 {{ margin: 0 0 15px; color: #1e40af; font-size: 1.2rem; }}
    .share-icons {{ display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }}
    .share-icon {{
      font-size: 1.2rem; cursor: pointer; transition: transform 0.2s;
      background: #f3f4f6; padding: 8px 16px; border-radius: 6px;
    }}
    .share-icon:hover {{ transform: scale(1.05); }}
    
    @media (max-width: 700px) {{
      .choice-container {{ flex-direction: column; }}
      .choice-card {{ width: 90vw; }}
      .header {{ padding: 10px; flex-direction: column; height: auto; }}
      .header h1 {{ font-size: 1.8rem; }}
      .controls-container {{ position: static; flex-direction: column; width: 100%; transform: none; margin-top: 15px; }}
      #font-slider-wrapper {{ width: 90%; }}
      #search-input {{ width: 90vw; }}
      .cards-container {{ grid-template-columns: 1fr; margin: 0 4vw; }}
    }}
  </style>
</head>
<body>

  <!-- ======================= شاشة البداية ======================= -->
  <div id="landing-page">
    <h1>تنزيل القرآن الكريم</h1>
      <p style="max-width: 600px; text-align: center; font-size: 1.1rem; color: #374151; margin-bottom: 40px;">
    <strong>(التّنزيلة)</strong><br>
    أحد العلوم الّتي يتناقلها حفظة القرآن الكريم في ليبيا، وهو وضع رقم على كلمة أو أكثر من آيات القرآن الكريم، تمييزا لها من جهة كتابتها أو موضعها في السّورة؛ تثبيتًا للحفظ أو تذكّرًا لطريقة كتابتها المختلفة عن غيرها.
  </p>
    <div class="choice-container">
      <div class="choice-card" onclick="startApp('app1')">
        <h2>استعرض التّنزيلات</h2>
        <p>وَفق العدد</p>
      </div>
      <div class="choice-card" onclick="startApp('app2')">
        <h2>استعرض التّنزيلات</h2>
        <p>وَفق السّورة</p>
      </div>
    </div>
  </div>

  <!-- ======================= واجهة التطبيق الرئيسية ======================= -->
  <div id="main-app">
    <div class="header">
        <div class="controls-container">
            <button id="home-btn">الرئيسية</button>
            <button id="top-back-btn">← رجوع</button>
            <div id="font-slider-wrapper">
              <label for="font-slider">حجم الخطّ</label>
              <input type="range" id="font-slider" min="0" max="6" value="2">
            </div>
        </div>
        <h1 id="app-title"></h1>
        <p id="current-note"></p>
    </div>
    
    <div class="search-container">
        <input type="text" id="search-input" placeholder="ابحث...">
    </div>
    
    <div class="cards-container" id="cards"></div>
    
    <div class="poem-container" id="poem-container">
        <div class="poem-box" id="poem-box"></div>
    </div>
    
    <div class="share-container" id="share-container">
        <div class="share-card">
          <h3>"مَنْ دَلَّ عَلَى خَيْرٍ، فَلَهُ مِثْلُ أَجْرُ فَاعِلِهِ"، (رواه مسلم).</h3>
              <h3>للتّواصل: aymen.nji@gmail.com</h3>
          <div class="share-icons">
            <span class="share-icon" onclick="shareTo('whatsapp')">واتساب</span>
            <span class="share-icon" onclick="shareTo('telegram')">تيليجرام</span>
            <span class="share-icon" onclick="shareTo('facebook')">فيسبوك</span>
            <span class="share-icon" onclick="shareTo('twitter')">إكس</span>
          </div>
        </div>
    </div>
  </div>

<script>
    // --- البيانات والمتغيرات العامة ---
    const records = {data_json};
    const allFontSizes = ["1rem", "1.25rem", "1.5rem", "1.75rem", "2rem", "2.5rem", "3rem"];
    let activeApp = null;
    let searchTerm = '';

    // --- عناصر الواجهة (DOM Elements) ---
    const landingPage = document.getElementById('landing-page');
    const mainApp = document.getElementById('main-app');
    const homeBtn = document.getElementById('home-btn');
    const backBtn = document.getElementById('top-back-btn');
    const searchInput = document.getElementById('search-input');
    const fontSlider = document.getElementById('font-slider');
    const cardsContainer = document.getElementById('cards');
    const poemContainer = document.getElementById('poem-container');
    const poemBox = document.getElementById('poem-box');
    const shareContainer = document.getElementById('share-container');
    const appTitle = document.getElementById('app-title');
    const currentNote = document.getElementById('current-note');

    // --- متغيرات الحالة لكل تطبيق ---
    let app1_state = {{ level: 0, selT: null, selG: null }};
    let app2_state = {{ level: 0, selSura: null, selTitle: null }};

    // --- دوال التحكم الرئيسية ---
    function startApp(appName) {{
        activeApp = appName;
        landingPage.style.display = 'none';
        mainApp.style.display = 'block';
        
        // إعادة تعيين الحالة والبحث عند بدء تطبيق جديد
        app1_state = {{ level: 0, selT: null, selG: null }};
        app2_state = {{ level: 0, selSura: null, selTitle: null }};
        searchInput.value = '';
        searchTerm = '';
        
        render();
    }}

    function showLandingPage() {{
        activeApp = null;
        mainApp.style.display = 'none';
        landingPage.style.display = 'flex';
    }}

    function render() {{
        if (activeApp === 'app1') {{
            renderApp1();
        }} else if (activeApp === 'app2') {{
            renderApp2();
        }}
    }}
    
    // --- معالجات الأحداث (Event Handlers) ---
    homeBtn.onclick = showLandingPage;
    
    backBtn.onclick = () => {{
        if (activeApp === 'app1' && app1_state.level > 0) {{
            app1_state.level--;
            render();
        }} else if (activeApp === 'app2' && app2_state.level > 0) {{
            app2_state.level--;
            render();
        }}
    }};

    searchInput.addEventListener('input', e => {{
        searchTerm = e.target.value.trim().toLowerCase();
        render();
    }});

    fontSlider.oninput = () => {{
        const newSize = allFontSizes[fontSlider.value];
        document.querySelectorAll('.card, .poem-box').forEach(el => {{
            el.style.fontSize = newSize;
        }});
    }};
    
    // --- دوال مساعدة مشتركة ---
    function highlightTags(text) {{
      return text ? text.replace(/<(?:red|blue)>(.*?)<\\/(?:red|blue)>/gi, '<span class="highlight">$1</span>') : '';
    }}

    function getFilteredRecords() {{
      if (!searchTerm) return records;
      return records.filter(r =>
        Object.values(r).some(val => 
          String(val).toLowerCase().includes(searchTerm)
        )
      );
    }}

    function applyCommonStylesAndFinalize() {{
        // تطبيق حجم الخط الحالي
        const currentSize = allFontSizes[fontSlider.value];
        document.querySelectorAll('.card, .poem-box').forEach(el => {{
            el.style.fontSize = currentSize;
        }});
        
        // إظهار رسالة "لا توجد نتائج" إذا كان الحاوية فارغة
        if (cardsContainer.children.length === 0) {{
            cardsContainer.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; padding: 40px; font-size: 1.2rem;">لا توجد نتائج مطابقة للبحث.</p>`;
        }}
    }}


    // ==========================================================
    //  ====== منطق التطبيق الأول (عرض حسب التنزيلة) ======
    // ==========================================================
    const app1_customOrder = [
      "غريبة","اثنان","ثلاثة","أربعة","خمسة","ستة","سبعة",
      "ثمانية","تسعة","عشرة","أحد عشر","اثنى عشر","ثلاثة عشر",
      "خمسة عشر","ثمانية عشر","تسعة عشر","عشرون","واحد وعشرون",
      "ثلاثة وثلاثون"
    ];

    function renderApp1() {{
        appTitle.textContent = "العرض حسب التنزيلة";
        cardsContainer.innerHTML = '';
        poemContainer.style.display = 'none';
        shareContainer.style.display = 'none';
        backBtn.disabled = app1_state.level === 0;

        const filtered = getFilteredRecords();
        
        if (app1_state.level === 0) {{
            currentNote.textContent = "";
            const counts = {{}};
            filtered.forEach(r => {{ counts[r['التنزيلة']] = (counts[r['التنزيلة']] || 0) + 1; }});
            
            const displayOrder = [...app1_customOrder, ...Object.keys(counts).filter(v => !app1_customOrder.includes(v)).sort((a, b) => a.localeCompare(b, 'ar'))];

            displayOrder.forEach(v => {{
              if (!counts[v]) return;
              const card = document.createElement('div');
              card.className = 'card';
              card.innerHTML = `<h3>${{v}}</h3><p class="count">${{counts[v]}} مجموعة</p>`;
              card.onclick = () => {{ app1_state.selT = v; app1_state.level = 1; render(); }};
              cardsContainer.appendChild(card);
            }});
        }}
        else if (app1_state.level === 1) {{
            currentNote.textContent = `التنزيلة: ${{app1_state.selT}}`;
            const subset = filtered.filter(r => r['التنزيلة'] === app1_state.selT);
            const groups = [...new Set(subset.map(r => r['مجموعة']))];

            groups.forEach(g => {{
              const rec = subset.find(r => r['مجموعة'] === g);
              const card = document.createElement('div');
              card.className = 'card';
              card.innerHTML = `<h3>${{rec['عنوان']}}</h3>`;
              card.onclick = () => {{ app1_state.selG = g; app1_state.level = 2; render(); }};
              cardsContainer.appendChild(card);
            }});
        }}
        else if (app1_state.level === 2) {{
            currentNote.textContent = `التنزيلة: ${{app1_state.selT}} | المجموعة: ${{filtered.find(r=>r['مجموعة']===app1_state.selG)?.['عنوان'] || ''}}`;
            filtered.filter(r => r['التنزيلة'] === app1_state.selT && r['مجموعة'] === app1_state.selG)
              .forEach(r => {{
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'default';
                card.innerHTML = `<p>${{highlightTags(r['ترميز'])}}</p><p class="sura">${{r['السورة']}}</p>`;
                cardsContainer.appendChild(card);
                
                if (r['البيت']) {{
                  poemContainer.style.display = 'block';
                  poemBox.innerHTML = `<p>${{r['البيت'].replace(/\\n/g, '<br>')}}</p>`;
                }}
              }});
            shareContainer.style.display = 'block';
        }}
        
        applyCommonStylesAndFinalize();
    }}

    // ==========================================================
    //  ====== منطق التطبيق الثاني (عرض حسب السورة) =======
    // ==========================================================
    function getSuraOrder(suraName) {{
        const suraOrder = {{
            "سورة الفاتحة": 1, "سورة البقرة": 2, "سورة آل عمران": 3, "سورة النّساء": 4,
            "سورة المائدة": 5, "سورة الأنعام": 6, "سورة الأعراف": 7, "سورة الأنفال": 8,
            "سورة التّوبة": 9, "سورة يونس": 10, "سورة هود": 11, "سورة يوسف": 12,
            "سورة الرّعد": 13, "سورة إبراهيم": 14, "سورة الحجر": 15, "سورة النّحل": 16,
            "سورة الإسراء": 17, "سورة الكهف": 18, "سورة مريم": 19, "سورة طه": 20,
            "سورة الأنبياء": 21, "سورة الحجّ": 22, "سورة المؤمنون": 23, "سورة النّور": 24,
            "سورة الفرقان": 25, "سورة الشّعراء": 26, "سورة النّمل": 27, "سورة القصص": 28,
            "سورة العنكبوت": 29, "سورة الرّوم": 30, "سورة لقمان": 31, "سورة السجدة": 32,
            "سورة الأحزاب": 33, "سورة سبأ": 34, "سورة فاطر": 35, "سورة يس": 36,
            "سورة الصّافّات": 37, "سورة ص": 38, "سورة الزّمر": 39, "سورة غافر": 40,
            "سورة فصلت": 41, "سورة الشّورى": 42, "سورة الزّخرف": 43, "سورة الدّخان": 44,
            "سورة الجاثية": 45, "سورة الأحقاف": 46, "سورة محمّد": 47, "سورة الفتح": 48,
            "سورة الحجرات": 49, "سورة ق": 50, "سورة الذّاريات": 51, "سورة الطّور": 52,
            "سورة النّجم": 53, "سورة القمر": 54, "سورة الرّحمن": 55, "سورة الواقعة": 56,
            "سورة الحديد": 57, "سورة المجادلة": 58, "سورة الحشر": 59, "سورة الممتحنة": 60,
            "سورة الصّفّ": 61, "سورة الجمعة": 62, "سورة المنافقون": 63, "سورة التّغابن": 64,
            "سورة الطّلاق": 65, "سورة التّحريم": 66, "سورة الملك": 67, "سورة القلم": 68,
            "سورة الحاقة": 69, "سورة المعارج": 70, "سورة نوح": 71, "سورة الجن": 72,
            "سورة المزمل": 73, "سورة المدثر": 74, "سورة القيامة": 75, "سورة الإنسان": 76,
            "سورة المرسلات": 77, "سورة النّبأ": 78, "سورة النّازعات": 79, "سورة عبس": 80,
            "سورة التّكوير": 81, "سورة الانفطار": 82, "سورة المطففين": 83, "سورة الانشقاق": 84,
            "سورة البروج": 85, "سورة الطّّارق": 86, "سورة الأعلي": 87, "سورة الغاشية": 88,
            "سورة الفجر": 89, "سورة البلد": 90, "سورة الشّمس": 91, "سورة اللّيل": 92,
            "سورة الضّحي": 93, "سورة الشّرح": 94, "سورة التّين": 95, "سورة العلق": 96,
            "سورة القدر": 97, "سورة البيّنة": 98, "سورة الزّلزلة": 99, "سورة العاديات": 100,
            "سورة القارعة": 101, "سورة التّكاثر": 102, "سورة العصر": 103, "سورة الهمزة": 104,
            "سورة الفيل": 105, "سورة قريش": 106, "سورة الماعون": 107, "سورة الكوثر": 108,
            "سورة الكافرون": 109, "سورة النّصر": 110, "سورة المسد": 111, "سورة الإخلاص": 112,
            "سورة الفلق": 113, "سورة النّاس": 114, "متكرّر": 115, "المتشابهات": 116
        }};
        return suraOrder[suraName] || 999;
    }}
    
    function renderApp2() {{
        appTitle.textContent = "العرض حسب السورة";
        cardsContainer.innerHTML = '';
        poemContainer.style.display = 'none';
        shareContainer.style.display = 'none';
        backBtn.disabled = app2_state.level === 0;
        
        const filtered = getFilteredRecords();

        if (app2_state.level === 0) {{
            currentNote.textContent = "اختر السورة";
            const suras = {{}};
            filtered.forEach(r => {{
                if (r['السورة']) {{ suras[r['السورة']] = (suras[r['السورة']] || 0) + 1; }}
            }});
            const sortedSuras = Object.keys(suras).sort((a, b) => getSuraOrder(a) - getSuraOrder(b));
            
            sortedSuras.forEach(sura => {{
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<h3>${{sura}}</h3><p class="count">${{suras[sura]}} تنزيلة</p>`;
                card.onclick = () => {{ app2_state.selSura = sura; app2_state.level = 1; render(); }};
                cardsContainer.appendChild(card);
            }});
        }}
        else if (app2_state.level === 1) {{
            currentNote.textContent = ` ${{app2_state.selSura}}`;
            const subset = filtered.filter(r => r['السورة'] === app2_state.selSura);
            const titles = [...new Set(subset.map(r => r['عنوان']))].filter(Boolean).sort();

            titles.forEach(title => {{
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<h3>${{title}}</h3>`;
                card.onclick = () => {{ app2_state.selTitle = title; app2_state.level = 2; render(); }};
                cardsContainer.appendChild(card);
            }});
        }}
        else if (app2_state.level === 2) {{
            currentNote.textContent = ` ${{app2_state.selSura}} | العنوان: ${{app2_state.selTitle}}`;
            
            // البحث عن كل المجموعات المرتبطة بهذا الاختيار
            const selectedRecords = filtered.filter(r => r['السورة'] === app2_state.selSura && r['عنوان'] === app2_state.selTitle);
            const relatedGroups = new Set(selectedRecords.map(r => r['مجموعة']).filter(Boolean));
            
            // عرض كل الآيات من كل السور التي تنتمي لهذه المجموعات
            const allRelatedRecords = records.filter(r => relatedGroups.has(r['مجموعة']));

            allRelatedRecords.forEach(item => {{
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'default';
                card.innerHTML = `
                    <p>${{highlightTags(item['ترميز'])}}</p>
                    <p class="sura">${{item['السورة']}}</p>
                    <p class="count">${{item['التنزيلة']}}</p>`;
                cardsContainer.appendChild(card);
            }});
            shareContainer.style.display = 'block';
        }}

        applyCommonStylesAndFinalize();
    }}

    // --- وظيفة المشاركة ---
    async function shareTo(platform) {{
        const elementToCapture = document.getElementById('cards');
        try {{
            const canvas = await html2canvas(elementToCapture, {{
                scale: 2,
                backgroundColor: '#f8fafc',
                useCORS: true
            }});
            const pageUrl = window.location.href;
            const text = `تنزيل القرآن الكريم\n${{currentNote.textContent}}\n\n`;
            
            let shareUrl = '';

            switch (platform) {{
                case 'whatsapp': shareUrl = `https://api.whatsapp.com/send?text=${{encodeURIComponent(text + pageUrl)}}`; break;
                case 'telegram': shareUrl = `https://t.me/share/url?url=${{encodeURIComponent(pageUrl)}}&text=${{encodeURIComponent(text)}}`; break;
                case 'facebook': shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${{encodeURIComponent(pageUrl)}}"e=${{encodeURIComponent(text)}}`; break;
                case 'twitter': shareUrl = `https://twitter.com/intent/tweet?url=${{encodeURIComponent(pageUrl)}}&text=${{encodeURIComponent(text)}}`; break;
            }}
            if (shareUrl) window.open(shareUrl, '_blank');
        }} catch(e) {{
            console.error("خطأ في المشاركة:", e);
            alert("حدث خطأ أثناء محاولة إنشاء الصورة للمشاركة.");
        }}
    }}

    // --- بدء التطبيق ---
    window.onload = showLandingPage;

</script>
</body>
</html>
"""

# --- 4. كتابة الملف وفتحه في المتصفح ---
try:
    with open(OUTPUT_HTML, "w", encoding="utf-8") as f:
        f.write(html_template)
    print(f"✅ تم إنشاء ملف HTML بنجاح: {OUTPUT_HTML.name}")
except Exception as e:
    print(f"خطأ في كتابة ملف HTML: {e}")
    sys.exit(1)

print("\nجاري فتح الملف في المتصفح...")
try:
    webbrowser.open(OUTPUT_HTML.as_uri())
    print("✓ تم فتح الملف في المتصفح بنجاح.")
except Exception as e:
    print(f"ملاحظة: لم أتمكن من فتح المتصفح تلقائياً. يمكنك فتح الملف يدوياً من المسار:\n{OUTPUT_HTML}")

print("\n🎉 اكتمل تنفيذ البرنامج بنجاح!")
