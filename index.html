import pandas as pd
import json
import base64
import os
import sys
import webbrowser
from pathlib import Path

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª ---
# ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù†ÙØ³ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø³ÙƒØ±Ø¨Øª
try:
    SCRIPT_DIR = Path(__file__).parent.absolute()
except NameError:
    # Ù„Ù„Ø¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø¨ÙŠØ¦Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ø«Ù„ Jupyter
    SCRIPT_DIR = Path.cwd()

EXCEL_FILE = SCRIPT_DIR / "ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ….xlsx"
FONT_FILE = SCRIPT_DIR / "UthmanicQalounV21.ttf"
OUTPUT_HTML = SCRIPT_DIR / "Ø¹Ø±Ø¶_Ø§Ù„Ù‚Ø±Ø¢Ù†_Ø§Ù„ÙƒØ±ÙŠÙ…_Ø§Ù„Ù…Ø¯Ù…Ø¬.html"

# --- 1. ØªØ­Ù…ÙŠÙ„ ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø®Ø· ---
print("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø®Ø·...")
try:
    with open(FONT_FILE, "rb") as f:
        font_data = f.read()
    font_base64 = base64.b64encode(font_data).decode("utf-8")
    css_font_face = f"""
    @font-face {{
      font-family: 'UthmanicQaloun';
      src: url(data:font/truetype;charset=utf-8;base64,{font_base64}) format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }}
    """
    print(f"âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·: {FONT_FILE.name}")
except FileNotFoundError:
    print(f"Ø®Ø·Ø£ ÙØ§Ø¯Ø­: Ù…Ù„Ù Ø§Ù„Ø®Ø· '{FONT_FILE.name}' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ÙŠØ±Ø¬Ù‰ ÙˆØ¶Ø¹Ù‡ Ø¨Ø¬Ø§Ù†Ø¨ Ù…Ù„Ù Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ†.")
    sys.exit(1)
except Exception as e:
    print(f"Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·: {e}")
    sys.exit(1)

# --- 2. ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙƒØ³Ù„ ---
print("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙƒØ³Ù„...")
try:
    df = pd.read_excel(EXCEL_FILE)
    print(f"âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {EXCEL_FILE.name} (Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: {len(df)})")
except FileNotFoundError:
    print(f"Ø®Ø·Ø£ ÙØ§Ø¯Ø­: Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ '{EXCEL_FILE.name}' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ÙŠØ±Ø¬Ù‰ ÙˆØ¶Ø¹Ù‡ Ø¨Ø¬Ø§Ù†Ø¨ Ù…Ù„Ù Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ†.")
    sys.exit(1)
except Exception as e:
    print(f"Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„: {e}")
    sys.exit(1)

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
required_columns = ["Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø©", "Ù…Ø¬Ù…ÙˆØ¹Ø©", "Ø¹Ù†ÙˆØ§Ù†", "ØªØ±Ù…ÙŠØ²", "Ø§Ù„Ø³ÙˆØ±Ø©", "Ø§Ù„Ø¨ÙŠØª"]
missing_columns = [col for col in required_columns if col not in df.columns]
if missing_columns:
    print(f"ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù: {', '.join(missing_columns)}. Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.")

# ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ JSON Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ§Ø±ØºØ©
records = df.fillna("").to_dict(orient="records")
data_json = json.dumps(records, ensure_ascii=False)


# --- 3. Ø¨Ù†Ø§Ø¡ Ù…Ù„Ù HTML Ø§Ù„Ù…Ø¯Ù…Ø¬ ---
html_template = f"""
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    {css_font_face}
    * {{ box-sizing: border-box; margin: 0; padding: 0; }}

    body {{
      font-family: 'UthmanicQaloun', 'Cairo', 'Segoe UI', sans-serif;
      background: linear-gradient(120deg, #f8fafc 70%, #e3eefe 100%);
      color: #2d3748;
      line-height: 1.7;
      min-height: 100vh;
    }}

    /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© --- */
    #landing-page {{
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }}
    #landing-page h1 {{
      font-size: 2.5rem;
      color: #1e3a8a;
      margin-bottom: 40px;
      text-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }}
    .choice-container {{
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      justify-content: center;
    }}
    .choice-card {{
      background: #fff;
      border: 1px solid #e0e7ff;
      border-radius: 16px;
      padding: 30px 40px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      width: 300px;
    }}
    .choice-card:hover {{
      transform: translateY(-8px);
      box-shadow: 0 12px 30px rgba(30, 64, 175, 0.15);
    }}
    .choice-card h2 {{
      color: #1e40af;
      font-size: 1.8rem;
      margin-bottom: 10px;
    }}
    .choice-card p {{
      font-size: 1.1rem;
      color: #4b5563;
    }}

    /* --- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ --- */
    #main-app {{ display: none; }}

    .header {{
      position: relative;
      padding: 20px 4vw;
      text-align: center;
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }}
    .header h1 {{ font-size: 2.3rem; color: #1e3a8a; }}
    #current-note {{ margin-top: 8px; font-size: 1.1rem; color: #4b5563; }}
    
    .controls-container {{
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        right: 4vw;
        display: flex;
        gap: 15px;
        align-items: center;
    }}

    #home-btn, #top-back-btn {{
      background: #1e40af;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: background 0.2s, transform 0.1s;
      font-size: 1rem;
      font-weight: 500;
      font-family: inherit;
    }}
    #home-btn:hover, #top-back-btn:hover {{
      background: #1e3a8a;
      transform: translateY(-2px);
    }}
    #top-back-btn:disabled {{
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }}

    #font-slider-wrapper {{
      background: rgba(255,255,255,0.9);
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }}
    #font-slider-wrapper label {{ font-weight: bold; color: #4b5563; margin-bottom: 4px; display: block; }}
    #font-slider {{ width: 150px; }}
    
    .search-container {{ margin: 20px 4vw; display: flex; justify-content: center; }}
    #search-input {{
      width: 100%; max-width: 500px; padding: 12px 16px; font-size: 1rem;
      border: 1px solid #d1d5db; border-radius: 8px; background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: border-color 0.2s, box-shadow 0.2s; font-family: inherit;
    }}
    #search-input:focus {{ outline: none; border-color: #1e40af; box-shadow: 0 0 0 3px rgba(30,64,175,0.2); }}

    .cards-container {{
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px; margin: 0 4vw 40px; padding-bottom: 20px;
    }}
    .card {{
      background: #fff; border: 1px solid #e0e7ff; border-radius: 12px;
      padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); cursor: pointer;
      transition: box-shadow 0.2s, transform 0.2s; text-align: center;
      min-height: 120px; font-size: 1.15rem; color: #2d3748;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }}
    .card:hover {{ box-shadow: 0 6px 16px rgba(0,0,0,0.1); transform: translateY(-3px); }}
    .card h3 {{ margin: 0 0 10px; color: #1e3a8a; }}
    .card p.count {{
      margin-top: 0.6rem; color: #1e40af; font-size: 0.95rem; font-weight: 600;
      background: #eff6ff; border-radius: 6px; padding: 4px 8px; display: inline-block;
    }}
    .card p.sura {{ margin-top: 0.6rem; color: #4b5563; font-size: 0.9rem; }}
    .highlight {{ color: #dc2626; font-weight: bold; }}

    .poem-container {{ display: none; margin: 40px auto; max-width: 600px; text-align: center; }}
    .poem-box {{
        background: #ffffff; border: 3px dashed #c7d2fe; border-radius: 12px;
        padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); line-height: 1.8;
    }}

    .share-container {{ display: none; margin: 40px 4vw; text-align: center; }}
    .share-card {{
      background: #fff; border: 1px solid #e0e7ff; border-radius: 12px; padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06); text-align: center;
    }}
    .share-card h3 {{ margin: 0 0 15px; color: #1e40af; font-size: 1.2rem; }}
    .share-icons {{ display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }}
    .share-icon {{
      font-size: 1.2rem; cursor: pointer; transition: transform 0.2s;
      background: #f3f4f6; padding: 8px 16px; border-radius: 6px;
    }}
    .share-icon:hover {{ transform: scale(1.05); }}
    
    @media (max-width: 700px) {{
      .choice-container {{ flex-direction: column; }}
      .choice-card {{ width: 90vw; }}
      .header {{ padding: 10px; flex-direction: column; height: auto; }}
      .header h1 {{ font-size: 1.8rem; }}
      .controls-container {{ position: static; flex-direction: column; width: 100%; transform: none; margin-top: 15px; }}
      #font-slider-wrapper {{ width: 90%; }}
      #search-input {{ width: 90vw; }}
      .cards-container {{ grid-template-columns: 1fr; margin: 0 4vw; }}
    }}
  </style>
</head>
<body>

  <!-- ======================= Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ======================= -->
  <div id="landing-page">
    <h1>ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1>
      <p style="max-width: 600px; text-align: center; font-size: 1.1rem; color: #374151; margin-bottom: 40px;">
    <strong>(Ø§Ù„ØªÙ‘Ù†Ø²ÙŠÙ„Ø©)</strong><br>
    Ø£Ø­Ø¯ Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ù‘ØªÙŠ ÙŠØªÙ†Ø§Ù‚Ù„Ù‡Ø§ Ø­ÙØ¸Ø© Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… ÙÙŠ Ù„ÙŠØ¨ÙŠØ§ØŒ ÙˆÙ‡Ùˆ ÙˆØ¶Ø¹ Ø±Ù‚Ù… Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ø£Ùˆ Ø£ÙƒØ«Ø± Ù…Ù† Ø¢ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ØŒ ØªÙ…ÙŠÙŠØ²Ø§ Ù„Ù‡Ø§ Ù…Ù† Ø¬Ù‡Ø© ÙƒØªØ§Ø¨ØªÙ‡Ø§ Ø£Ùˆ Ù…ÙˆØ¶Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ø³Ù‘ÙˆØ±Ø©Ø› ØªØ«Ø¨ÙŠØªÙ‹Ø§ Ù„Ù„Ø­ÙØ¸ Ø£Ùˆ ØªØ°ÙƒÙ‘Ø±Ù‹Ø§ Ù„Ø·Ø±ÙŠÙ‚Ø© ÙƒØªØ§Ø¨ØªÙ‡Ø§ Ø§Ù„Ù…Ø®ØªÙ„ÙØ© Ø¹Ù† ØºÙŠØ±Ù‡Ø§.
  </p>
    <div class="choice-container">
      <div class="choice-card" onclick="startApp('app1')">
        <h2>Ø§Ø³ØªØ¹Ø±Ø¶ Ø§Ù„ØªÙ‘Ù†Ø²ÙŠÙ„Ø§Øª</h2>
        <p>ÙˆÙÙÙ‚ Ø§Ù„Ø¹Ø¯Ø¯</p>
      </div>
      <div class="choice-card" onclick="startApp('app2')">
        <h2>Ø§Ø³ØªØ¹Ø±Ø¶ Ø§Ù„ØªÙ‘Ù†Ø²ÙŠÙ„Ø§Øª</h2>
        <p>ÙˆÙÙÙ‚ Ø§Ù„Ø³Ù‘ÙˆØ±Ø©</p>
      </div>
    </div>
  </div>

  <!-- ======================= ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ======================= -->
  <div id="main-app">
    <div class="header">
        <div class="controls-container">
            <button id="home-btn">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <button id="top-back-btn">â† Ø±Ø¬ÙˆØ¹</button>
            <div id="font-slider-wrapper">
              <label for="font-slider">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·Ù‘</label>
              <input type="range" id="font-slider" min="0" max="6" value="2">
            </div>
        </div>
        <h1 id="app-title"></h1>
        <p id="current-note"></p>
    </div>
    
    <div class="search-container">
        <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø«...">
    </div>
    
    <div class="cards-container" id="cards"></div>
    
    <div class="poem-container" id="poem-container">
        <div class="poem-box" id="poem-box"></div>
    </div>
    
    <div class="share-container" id="share-container">
        <div class="share-card">
          <h3>"Ù…ÙÙ†Ù’ Ø¯ÙÙ„ÙÙ‘ Ø¹ÙÙ„ÙÙ‰ Ø®ÙÙŠÙ’Ø±ÙØŒ ÙÙÙ„ÙÙ‡Ù Ù…ÙØ«Ù’Ù„Ù Ø£ÙØ¬Ù’Ø±Ù ÙÙØ§Ø¹ÙÙ„ÙÙ‡Ù"ØŒ (Ø±ÙˆØ§Ù‡ Ù…Ø³Ù„Ù…).</h3>
              <h3>Ù„Ù„ØªÙ‘ÙˆØ§ØµÙ„: aymen.nji@gmail.com</h3>
          <div class="share-icons">
            <span class="share-icon" onclick="shareTo('whatsapp')">ÙˆØ§ØªØ³Ø§Ø¨</span>
            <span class="share-icon" onclick="shareTo('telegram')">ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</span>
            <span class="share-icon" onclick="shareTo('facebook')">ÙÙŠØ³Ø¨ÙˆÙƒ</span>
            <span class="share-icon" onclick="shareTo('twitter')">Ø¥ÙƒØ³</span>
          </div>
        </div>
    </div>
  </div>

<script>
    // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
    const records = {data_json};
    const allFontSizes = ["1rem", "1.25rem", "1.5rem", "1.75rem", "2rem", "2.5rem", "3rem"];
    let activeApp = null;
    let searchTerm = '';

    // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (DOM Elements) ---
    const landingPage = document.getElementById('landing-page');
    const mainApp = document.getElementById('main-app');
    const homeBtn = document.getElementById('home-btn');
    const backBtn = document.getElementById('top-back-btn');
    const searchInput = document.getElementById('search-input');
    const fontSlider = document.getElementById('font-slider');
    const cardsContainer = document.getElementById('cards');
    const poemContainer = document.getElementById('poem-container');
    const poemBox = document.getElementById('poem-box');
    const shareContainer = document.getElementById('share-container');
    const appTitle = document.getElementById('app-title');
    const currentNote = document.getElementById('current-note');

    // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ù„ÙƒÙ„ ØªØ·Ø¨ÙŠÙ‚ ---
    let app1_state = {{ level: 0, selT: null, selG: null }};
    let app2_state = {{ level: 0, selSura: null, selTitle: null }};

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
    function startApp(appName) {{
        activeApp = appName;
        landingPage.style.display = 'none';
        mainApp.style.display = 'block';
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯
        app1_state = {{ level: 0, selT: null, selG: null }};
        app2_state = {{ level: 0, selSura: null, selTitle: null }};
        searchInput.value = '';
        searchTerm = '';
        
        render();
    }}

    function showLandingPage() {{
        activeApp = null;
        mainApp.style.display = 'none';
        landingPage.style.display = 'flex';
    }}

    function render() {{
        if (activeApp === 'app1') {{
            renderApp1();
        }} else if (activeApp === 'app2') {{
            renderApp2();
        }}
    }}
    
    // --- Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Handlers) ---
    homeBtn.onclick = showLandingPage;
    
    backBtn.onclick = () => {{
        if (activeApp === 'app1' && app1_state.level > 0) {{
            app1_state.level--;
            render();
        }} else if (activeApp === 'app2' && app2_state.level > 0) {{
            app2_state.level--;
            render();
        }}
    }};

    searchInput.addEventListener('input', e => {{
        searchTerm = e.target.value.trim().toLowerCase();
        render();
    }});

    fontSlider.oninput = () => {{
        const newSize = allFontSizes[fontSlider.value];
        document.querySelectorAll('.card, .poem-box').forEach(el => {{
            el.style.fontSize = newSize;
        }});
    }};
    
    // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø´ØªØ±ÙƒØ© ---
    function highlightTags(text) {{
      return text ? text.replace(/<(?:red|blue)>(.*?)<\\/(?:red|blue)>/gi, '<span class="highlight">$1</span>') : '';
    }}

    function getFilteredRecords() {{
      if (!searchTerm) return records;
      return records.filter(r =>
        Object.values(r).some(val => 
          String(val).toLowerCase().includes(searchTerm)
        )
      );
    }}

    function applyCommonStylesAndFinalize() {{
        // ØªØ·Ø¨ÙŠÙ‚ Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
        const currentSize = allFontSizes[fontSlider.value];
        document.querySelectorAll('.card, .poem-box').forEach(el => {{
            el.style.fontSize = currentSize;
        }});
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬" Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø§ÙˆÙŠØ© ÙØ§Ø±ØºØ©
        if (cardsContainer.children.length === 0) {{
            cardsContainer.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; padding: 40px; font-size: 1.2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.</p>`;
        }}
    }}


    // ==========================================================
    //  ====== Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„ (Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø©) ======
    // ==========================================================
    const app1_customOrder = [
      "ØºØ±ÙŠØ¨Ø©","Ø§Ø«Ù†Ø§Ù†","Ø«Ù„Ø§Ø«Ø©","Ø£Ø±Ø¨Ø¹Ø©","Ø®Ù…Ø³Ø©","Ø³ØªØ©","Ø³Ø¨Ø¹Ø©",
      "Ø«Ù…Ø§Ù†ÙŠØ©","ØªØ³Ø¹Ø©","Ø¹Ø´Ø±Ø©","Ø£Ø­Ø¯ Ø¹Ø´Ø±","Ø§Ø«Ù†Ù‰ Ø¹Ø´Ø±","Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±",
      "Ø®Ù…Ø³Ø© Ø¹Ø´Ø±","Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±","ØªØ³Ø¹Ø© Ø¹Ø´Ø±","Ø¹Ø´Ø±ÙˆÙ†","ÙˆØ§Ø­Ø¯ ÙˆØ¹Ø´Ø±ÙˆÙ†",
      "Ø«Ù„Ø§Ø«Ø© ÙˆØ«Ù„Ø§Ø«ÙˆÙ†"
    ];

    function renderApp1() {{
        appTitle.textContent = "Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø©";
        cardsContainer.innerHTML = '';
        poemContainer.style.display = 'none';
        shareContainer.style.display = 'none';
        backBtn.disabled = app1_state.level === 0;

        const filtered = getFilteredRecords();
        
        if (app1_state.level === 0) {{
            currentNote.textContent = "";
            const counts = {{}};
            filtered.forEach(r => {{ counts[r['Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø©']] = (counts[r['Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø©']] || 0) + 1; }});
            
            const displayOrder = [...app1_customOrder, ...Object.keys(counts).filter(v => !app1_customOrder.includes(v)).sort((a, b) => a.localeCompare(b, 'ar'))];

            displayOrder.forEach(v => {{
              if (!counts[v]) return;
              const card = document.createElement('div');
              card.className = 'card';
              card.innerHTML = `<h3>${{v}}</h3><p class="count">${{counts[v]}} Ù…Ø¬Ù…ÙˆØ¹Ø©</p>`;
              card.onclick = () => {{ app1_state.selT = v; app1_state.level = 1; render(); }};
              cardsContainer.appendChild(card);
            }});
        }}
        else if (app1_state.level === 1) {{
            currentNote.textContent = `Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø©: ${{app1_state.selT}}`;
            const subset = filtered.filter(r => r['Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø©'] === app1_state.selT);
            const groups = [...new Set(subset.map(r => r['Ù…Ø¬Ù…ÙˆØ¹Ø©']))];

            groups.forEach(g => {{
              const rec = subset.find(r => r['Ù…Ø¬Ù…ÙˆØ¹Ø©'] === g);
              const card = document.createElement('div');
              card.className = 'card';
              card.innerHTML = `<h3>${{rec['Ø¹Ù†ÙˆØ§Ù†']}}</h3>`;
              card.onclick = () => {{ app1_state.selG = g; app1_state.level = 2; render(); }};
              cardsContainer.appendChild(card);
            }});
        }}
        else if (app1_state.level === 2) {{
            currentNote.textContent = `Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø©: ${{app1_state.selT}} | Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${{filtered.find(r=>r['Ù…Ø¬Ù…ÙˆØ¹Ø©']===app1_state.selG)?.['Ø¹Ù†ÙˆØ§Ù†'] || ''}}`;
            filtered.filter(r => r['Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø©'] === app1_state.selT && r['Ù…Ø¬Ù…ÙˆØ¹Ø©'] === app1_state.selG)
              .forEach(r => {{
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'default';
                card.innerHTML = `<p>${{highlightTags(r['ØªØ±Ù…ÙŠØ²'])}}</p><p class="sura">${{r['Ø§Ù„Ø³ÙˆØ±Ø©']}}</p>`;
                cardsContainer.appendChild(card);
                
                if (r['Ø§Ù„Ø¨ÙŠØª']) {{
                  poemContainer.style.display = 'block';
                  poemBox.innerHTML = `<p>${{r['Ø§Ù„Ø¨ÙŠØª'].replace(/\\n/g, '<br>')}}</p>`;
                }}
              }});
            shareContainer.style.display = 'block';
        }}
        
        applyCommonStylesAndFinalize();
    }}

    // ==========================================================
    //  ====== Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ±Ø©) =======
    // ==========================================================
    function getSuraOrder(suraName) {{
        const suraOrder = {{
            "Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø©": 1, "Ø³ÙˆØ±Ø© Ø§Ù„Ø¨Ù‚Ø±Ø©": 2, "Ø³ÙˆØ±Ø© Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†": 3, "Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ù‘Ø³Ø§Ø¡": 4,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©": 5, "Ø³ÙˆØ±Ø© Ø§Ù„Ø£Ù†Ø¹Ø§Ù…": 6, "Ø³ÙˆØ±Ø© Ø§Ù„Ø£Ø¹Ø±Ø§Ù": 7, "Ø³ÙˆØ±Ø© Ø§Ù„Ø£Ù†ÙØ§Ù„": 8,
            "Ø³ÙˆØ±Ø© Ø§Ù„ØªÙ‘ÙˆØ¨Ø©": 9, "Ø³ÙˆØ±Ø© ÙŠÙˆÙ†Ø³": 10, "Ø³ÙˆØ±Ø© Ù‡ÙˆØ¯": 11, "Ø³ÙˆØ±Ø© ÙŠÙˆØ³Ù": 12,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ø±Ù‘Ø¹Ø¯": 13, "Ø³ÙˆØ±Ø© Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…": 14, "Ø³ÙˆØ±Ø© Ø§Ù„Ø­Ø¬Ø±": 15, "Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ù‘Ø­Ù„": 16,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡": 17, "Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ù": 18, "Ø³ÙˆØ±Ø© Ù…Ø±ÙŠÙ…": 19, "Ø³ÙˆØ±Ø© Ø·Ù‡": 20,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡": 21, "Ø³ÙˆØ±Ø© Ø§Ù„Ø­Ø¬Ù‘": 22, "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†": 23, "Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ù‘ÙˆØ±": 24,
            "Ø³ÙˆØ±Ø© Ø§Ù„ÙØ±Ù‚Ø§Ù†": 25, "Ø³ÙˆØ±Ø© Ø§Ù„Ø´Ù‘Ø¹Ø±Ø§Ø¡": 26, "Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ù‘Ù…Ù„": 27, "Ø³ÙˆØ±Ø© Ø§Ù„Ù‚ØµØµ": 28,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª": 29, "Ø³ÙˆØ±Ø© Ø§Ù„Ø±Ù‘ÙˆÙ…": 30, "Ø³ÙˆØ±Ø© Ù„Ù‚Ù…Ø§Ù†": 31, "Ø³ÙˆØ±Ø© Ø§Ù„Ø³Ø¬Ø¯Ø©": 32,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ø£Ø­Ø²Ø§Ø¨": 33, "Ø³ÙˆØ±Ø© Ø³Ø¨Ø£": 34, "Ø³ÙˆØ±Ø© ÙØ§Ø·Ø±": 35, "Ø³ÙˆØ±Ø© ÙŠØ³": 36,
            "Ø³ÙˆØ±Ø© Ø§Ù„ØµÙ‘Ø§ÙÙ‘Ø§Øª": 37, "Ø³ÙˆØ±Ø© Øµ": 38, "Ø³ÙˆØ±Ø© Ø§Ù„Ø²Ù‘Ù…Ø±": 39, "Ø³ÙˆØ±Ø© ØºØ§ÙØ±": 40,
            "Ø³ÙˆØ±Ø© ÙØµÙ„Øª": 41, "Ø³ÙˆØ±Ø© Ø§Ù„Ø´Ù‘ÙˆØ±Ù‰": 42, "Ø³ÙˆØ±Ø© Ø§Ù„Ø²Ù‘Ø®Ø±Ù": 43, "Ø³ÙˆØ±Ø© Ø§Ù„Ø¯Ù‘Ø®Ø§Ù†": 44,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ø¬Ø§Ø«ÙŠØ©": 45, "Ø³ÙˆØ±Ø© Ø§Ù„Ø£Ø­Ù‚Ø§Ù": 46, "Ø³ÙˆØ±Ø© Ù…Ø­Ù…Ù‘Ø¯": 47, "Ø³ÙˆØ±Ø© Ø§Ù„ÙØªØ­": 48,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ø­Ø¬Ø±Ø§Øª": 49, "Ø³ÙˆØ±Ø© Ù‚": 50, "Ø³ÙˆØ±Ø© Ø§Ù„Ø°Ù‘Ø§Ø±ÙŠØ§Øª": 51, "Ø³ÙˆØ±Ø© Ø§Ù„Ø·Ù‘ÙˆØ±": 52,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ù‘Ø¬Ù…": 53, "Ø³ÙˆØ±Ø© Ø§Ù„Ù‚Ù…Ø±": 54, "Ø³ÙˆØ±Ø© Ø§Ù„Ø±Ù‘Ø­Ù…Ù†": 55, "Ø³ÙˆØ±Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©": 56,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ø­Ø¯ÙŠØ¯": 57, "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©": 58, "Ø³ÙˆØ±Ø© Ø§Ù„Ø­Ø´Ø±": 59, "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©": 60,
            "Ø³ÙˆØ±Ø© Ø§Ù„ØµÙ‘ÙÙ‘": 61, "Ø³ÙˆØ±Ø© Ø§Ù„Ø¬Ù…Ø¹Ø©": 62, "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†": 63, "Ø³ÙˆØ±Ø© Ø§Ù„ØªÙ‘ØºØ§Ø¨Ù†": 64,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ø·Ù‘Ù„Ø§Ù‚": 65, "Ø³ÙˆØ±Ø© Ø§Ù„ØªÙ‘Ø­Ø±ÙŠÙ…": 66, "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ù„Ùƒ": 67, "Ø³ÙˆØ±Ø© Ø§Ù„Ù‚Ù„Ù…": 68,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù‚Ø©": 69, "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬": 70, "Ø³ÙˆØ±Ø© Ù†ÙˆØ­": 71, "Ø³ÙˆØ±Ø© Ø§Ù„Ø¬Ù†": 72,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø²Ù…Ù„": 73, "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø¯Ø«Ø±": 74, "Ø³ÙˆØ±Ø© Ø§Ù„Ù‚ÙŠØ§Ù…Ø©": 75, "Ø³ÙˆØ±Ø© Ø§Ù„Ø¥Ù†Ø³Ø§Ù†": 76,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª": 77, "Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ù‘Ø¨Ø£": 78, "Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ù‘Ø§Ø²Ø¹Ø§Øª": 79, "Ø³ÙˆØ±Ø© Ø¹Ø¨Ø³": 80,
            "Ø³ÙˆØ±Ø© Ø§Ù„ØªÙ‘ÙƒÙˆÙŠØ±": 81, "Ø³ÙˆØ±Ø© Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±": 82, "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø·ÙÙÙŠÙ†": 83, "Ø³ÙˆØ±Ø© Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚": 84,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆØ¬": 85, "Ø³ÙˆØ±Ø© Ø§Ù„Ø·Ù‘Ù‘Ø§Ø±Ù‚": 86, "Ø³ÙˆØ±Ø© Ø§Ù„Ø£Ø¹Ù„ÙŠ": 87, "Ø³ÙˆØ±Ø© Ø§Ù„ØºØ§Ø´ÙŠØ©": 88,
            "Ø³ÙˆØ±Ø© Ø§Ù„ÙØ¬Ø±": 89, "Ø³ÙˆØ±Ø© Ø§Ù„Ø¨Ù„Ø¯": 90, "Ø³ÙˆØ±Ø© Ø§Ù„Ø´Ù‘Ù…Ø³": 91, "Ø³ÙˆØ±Ø© Ø§Ù„Ù„Ù‘ÙŠÙ„": 92,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ø¶Ù‘Ø­ÙŠ": 93, "Ø³ÙˆØ±Ø© Ø§Ù„Ø´Ù‘Ø±Ø­": 94, "Ø³ÙˆØ±Ø© Ø§Ù„ØªÙ‘ÙŠÙ†": 95, "Ø³ÙˆØ±Ø© Ø§Ù„Ø¹Ù„Ù‚": 96,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ù‚Ø¯Ø±": 97, "Ø³ÙˆØ±Ø© Ø§Ù„Ø¨ÙŠÙ‘Ù†Ø©": 98, "Ø³ÙˆØ±Ø© Ø§Ù„Ø²Ù‘Ù„Ø²Ù„Ø©": 99, "Ø³ÙˆØ±Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª": 100,
            "Ø³ÙˆØ±Ø© Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©": 101, "Ø³ÙˆØ±Ø© Ø§Ù„ØªÙ‘ÙƒØ§Ø«Ø±": 102, "Ø³ÙˆØ±Ø© Ø§Ù„Ø¹ØµØ±": 103, "Ø³ÙˆØ±Ø© Ø§Ù„Ù‡Ù…Ø²Ø©": 104,
            "Ø³ÙˆØ±Ø© Ø§Ù„ÙÙŠÙ„": 105, "Ø³ÙˆØ±Ø© Ù‚Ø±ÙŠØ´": 106, "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†": 107, "Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙˆØ«Ø±": 108,
            "Ø³ÙˆØ±Ø© Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†": 109, "Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ù‘ØµØ±": 110, "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø³Ø¯": 111, "Ø³ÙˆØ±Ø© Ø§Ù„Ø¥Ø®Ù„Ø§Øµ": 112,
            "Ø³ÙˆØ±Ø© Ø§Ù„ÙÙ„Ù‚": 113, "Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ù‘Ø§Ø³": 114, "Ù…ØªÙƒØ±Ù‘Ø±": 115, "Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª": 116
        }};
        return suraOrder[suraName] || 999;
    }}
    
    function renderApp2() {{
        appTitle.textContent = "Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ±Ø©";
        cardsContainer.innerHTML = '';
        poemContainer.style.display = 'none';
        shareContainer.style.display = 'none';
        backBtn.disabled = app2_state.level === 0;
        
        const filtered = getFilteredRecords();

        if (app2_state.level === 0) {{
            currentNote.textContent = "Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø©";
            const suras = {{}};
            filtered.forEach(r => {{
                if (r['Ø§Ù„Ø³ÙˆØ±Ø©']) {{ suras[r['Ø§Ù„Ø³ÙˆØ±Ø©']] = (suras[r['Ø§Ù„Ø³ÙˆØ±Ø©']] || 0) + 1; }}
            }});
            const sortedSuras = Object.keys(suras).sort((a, b) => getSuraOrder(a) - getSuraOrder(b));
            
            sortedSuras.forEach(sura => {{
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<h3>${{sura}}</h3><p class="count">${{suras[sura]}} ØªÙ†Ø²ÙŠÙ„Ø©</p>`;
                card.onclick = () => {{ app2_state.selSura = sura; app2_state.level = 1; render(); }};
                cardsContainer.appendChild(card);
            }});
        }}
        else if (app2_state.level === 1) {{
            currentNote.textContent = ` ${{app2_state.selSura}}`;
            const subset = filtered.filter(r => r['Ø§Ù„Ø³ÙˆØ±Ø©'] === app2_state.selSura);
            const titles = [...new Set(subset.map(r => r['Ø¹Ù†ÙˆØ§Ù†']))].filter(Boolean).sort();

            titles.forEach(title => {{
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<h3>${{title}}</h3>`;
                card.onclick = () => {{ app2_state.selTitle = title; app2_state.level = 2; render(); }};
                cardsContainer.appendChild(card);
            }});
        }}
        else if (app2_state.level === 2) {{
            currentNote.textContent = ` ${{app2_state.selSura}} | Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${{app2_state.selTitle}}`;
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            const selectedRecords = filtered.filter(r => r['Ø§Ù„Ø³ÙˆØ±Ø©'] === app2_state.selSura && r['Ø¹Ù†ÙˆØ§Ù†'] === app2_state.selTitle);
            const relatedGroups = new Set(selectedRecords.map(r => r['Ù…Ø¬Ù…ÙˆØ¹Ø©']).filter(Boolean));
            
            // Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¢ÙŠØ§Øª Ù…Ù† ÙƒÙ„ Ø§Ù„Ø³ÙˆØ± Ø§Ù„ØªÙŠ ØªÙ†ØªÙ…ÙŠ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
            const allRelatedRecords = records.filter(r => relatedGroups.has(r['Ù…Ø¬Ù…ÙˆØ¹Ø©']));

            allRelatedRecords.forEach(item => {{
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'default';
                card.innerHTML = `
                    <p>${{highlightTags(item['ØªØ±Ù…ÙŠØ²'])}}</p>
                    <p class="sura">${{item['Ø§Ù„Ø³ÙˆØ±Ø©']}}</p>
                    <p class="count">${{item['Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø©']}}</p>`;
                cardsContainer.appendChild(card);
            }});
            shareContainer.style.display = 'block';
        }}

        applyCommonStylesAndFinalize();
    }}

    // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ---
    async function shareTo(platform) {{
        const elementToCapture = document.getElementById('cards');
        try {{
            const canvas = await html2canvas(elementToCapture, {{
                scale: 2,
                backgroundColor: '#f8fafc',
                useCORS: true
            }});
            const pageUrl = window.location.href;
            const text = `ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…\n${{currentNote.textContent}}\n\n`;
            
            let shareUrl = '';

            switch (platform) {{
                case 'whatsapp': shareUrl = `https://api.whatsapp.com/send?text=${{encodeURIComponent(text + pageUrl)}}`; break;
                case 'telegram': shareUrl = `https://t.me/share/url?url=${{encodeURIComponent(pageUrl)}}&text=${{encodeURIComponent(text)}}`; break;
                case 'facebook': shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${{encodeURIComponent(pageUrl)}}"e=${{encodeURIComponent(text)}}`; break;
                case 'twitter': shareUrl = `https://twitter.com/intent/tweet?url=${{encodeURIComponent(pageUrl)}}&text=${{encodeURIComponent(text)}}`; break;
            }}
            if (shareUrl) window.open(shareUrl, '_blank');
        }} catch(e) {{
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©:", e);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©.");
        }}
    }}

    // --- Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
    window.onload = showLandingPage;

</script>
</body>
</html>
"""

# --- 4. ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù ÙˆÙØªØ­Ù‡ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ ---
try:
    with open(OUTPUT_HTML, "w", encoding="utf-8") as f:
        f.write(html_template)
    print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù HTML Ø¨Ù†Ø¬Ø§Ø­: {OUTPUT_HTML.name}")
except Exception as e:
    print(f"Ø®Ø·Ø£ ÙÙŠ ÙƒØªØ§Ø¨Ø© Ù…Ù„Ù HTML: {e}")
    sys.exit(1)

print("\nØ¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­...")
try:
    webbrowser.open(OUTPUT_HTML.as_uri())
    print("âœ“ ØªÙ… ÙØªØ­ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ù†Ø¬Ø§Ø­.")
except Exception as e:
    print(f"Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† ÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ ÙØªØ­ Ø§Ù„Ù…Ù„Ù ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±:\n{OUTPUT_HTML}")

print("\nğŸ‰ Ø§ÙƒØªÙ…Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­!")
